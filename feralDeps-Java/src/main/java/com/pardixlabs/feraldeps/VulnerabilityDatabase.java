//this is currently a mock implementation of a DB

package com.pardixlabs.feraldeps;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.*;

public class VulnerabilityDatabase {

    // Cache to avoid repeated API calls
    private static final Map<String, String> versionCache = new HashMap<>();
    private static final Map<String, Boolean> vulnerabilityCache = new HashMap<>();

    public static Optional<String> latestVersion(String coordinate) {
        // Check cache first
        if (versionCache.containsKey(coordinate)) {
            return Optional.ofNullable(versionCache.get(coordinate));
        }

        try {
            String[] parts = coordinate.split(":");
            if (parts.length != 2) return Optional.empty();
            
            String groupId = parts[0];
            String artifactId = parts[1];
            
            // Query Maven Central API
            String urlString = "https://search.maven.org/solrsearch/select?q=g:" + 
                groupId + "+AND+a:" + artifactId + "&rows=1&wt=json";
            
            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("GET");
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);
            
            int responseCode = conn.getResponseCode();
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();
                
                // Parse JSON response (simple string parsing to avoid dependencies)
                String json = response.toString();
                String latestVersion = extractLatestVersion(json);
                
                if (latestVersion != null) {
                    versionCache.put(coordinate, latestVersion);
                    return Optional.of(latestVersion);
                }
            }
        } catch (Exception e) {
            // Silently fail - API might be unreachable
            System.err.println("Failed to fetch latest version for " + coordinate + ": " + e.getMessage());
        }
        
        versionCache.put(coordinate, null);
        return Optional.empty();
    }

    public static boolean isVulnerable(Dependency dep) {
        String key = dep.coordinate() + ":" + dep.version;
        
        // Check cache first
        if (vulnerabilityCache.containsKey(key)) {
            return vulnerabilityCache.get(key);
        }

        try {
            // Query OSV (Open Source Vulnerabilities) API
            String packageName = "pkg:maven/" + dep.groupId + "/" + dep.artifactId + "@" + dep.version;
            
            URL url = new URL("https://api.osv.dev/v1/query");
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setDoOutput(true);
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);
            
            String jsonInputString = "{\"package\":{\"name\":\"" + dep.groupId + ":" + dep.artifactId + 
                "\",\"ecosystem\":\"Maven\"},\"version\":\"" + dep.version + "\"}";
            
            try (OutputStream os = conn.getOutputStream()) {
                byte[] input = jsonInputString.getBytes(StandardCharsets.UTF_8);
                os.write(input, 0, input.length);
            }
            
            int responseCode = conn.getResponseCode();
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();
                
                // Check if response contains vulnerabilities
                String json = response.toString();
                boolean hasVulns = json.contains("\"vulns\"") && !json.contains("\"vulns\":[]");
                
                vulnerabilityCache.put(key, hasVulns);
                return hasVulns;
            }
        } catch (Exception e) {
            // Silently fail - API might be unreachable
            System.err.println("Failed to check vulnerabilities for " + key + ": " + e.getMessage());
        }
        
        vulnerabilityCache.put(key, false);
        return false;
    }

    private static String extractLatestVersion(String json) {
        // Simple JSON parsing without external dependencies
        int vIndex = json.indexOf("\"latestVersion\":\"");
        if (vIndex == -1) return null;
        
        int start = vIndex + 17; // length of "latestVersion":"
        int end = json.indexOf("\"", start);
        if (end == -1) return null;
        
        return json.substring(start, end);
    }
}
